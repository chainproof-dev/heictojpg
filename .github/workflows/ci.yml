  - name: Install system dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y \
        pkg-config \
        cmake \
        nasm \
        build-essential \
        libheif-dev \
        libjpeg-turbo8-dev \
        libde265-dev

  - name: Setup Rust
    uses: actions/setup-rust@v1
    with:
      toolchain: stable
      override: true

  - name: Cache cargo registry and target
    uses: actions/cache@v4
    with:
      path: |
        ~/.cargo/registry
        ~/.cargo/git
        target
      key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      restore-keys: |
        ${{ runner.os }}-cargo-

  - name: Build
    run: cargo build --verbose

  - name: Run tests
    run: cargo test --verbose
